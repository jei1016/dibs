{# Recursively render a section's pages and subsections #}
{% macro render_section_tree(section, current_path) %}
    {% set pages = section.pages | sort(attribute="weight") %}
    {% set subsections = section.subsections | sort(attribute="weight") %}

    {% if pages | length > 0 or subsections | length > 0 %}
    <ul class="sidebar-list">
        {% for page in pages %}
        <li>
            <a href="{{ page.permalink }}" {% if current_path == page.permalink %}class="active"{% endif %}>
                {{ page.title or page.path }}
            </a>
        </li>
        {% endfor %}

        {% for subsection_path in subsections %}
            {% set subsection = get_section(path=subsection_path) %}
        <li class="has-children{% if current_path is starting_with(subsection.permalink) %} expanded{% endif %}">
            <a href="{{ subsection.permalink }}" {% if current_path is starting_with(subsection.permalink) %}class="active"{% endif %}>
                {{ subsection.title or subsection.path }}
            </a>
            {{ self::render_section_tree(section=subsection, current_path=current_path) }}
        </li>
        {% endfor %}
    </ul>
    {% endif %}
{% endmacro %}

{% macro sidebar(root_section_path, current_path) %}
    {% set root = get_section(path=root_section_path) %}
    <aside class="sidebar">
        <nav class="sidebar-nav">
            <a href="{{ root.permalink }}" class="sidebar-title">{{ root.title or root.path }}</a>
            {{ self::render_section_tree(section=root, current_path=current_path) }}
        </nav>
    </aside>
{% endmacro %}
