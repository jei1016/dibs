tests (
    {
        name "table completions after from"
        input "from |"
        completions {has (product product_variant variant_price product_source product_translation)}
    }

    {
        name "table completions with prefix"
        input "from prod|"
        completions {
            has (product product_variant product_source product_translation)
        }
    }

    {
        name "context-aware column completions in select"
        input <<STYX
            AllProducts @query{
                from product
                select {|}
            }
            STYX
        completions {
            has (id handle status active metadata created_at updated_at deleted_at)
        }
    }

    {
        name "column completions with prefix"
        input <<STYX
            AllProducts @query{
                from product
                select {ha|}
            }
            STYX
        completions {
            has (handle)
        }
    }

    {
        name "column completions in where clause"
        input <<STYX
            AllProducts @query{
                from product
                where {|}
            }
            STYX
        completions {
            has (id handle status active metadata created_at updated_at deleted_at)
        }
    }

    {
        name "column completions in order_by"
        input <<STYX
            AllProducts @query{
                from product
                order_by {|}
            }
            STYX
        completions {
            has (id handle status active created_at updated_at)
        }
    }

    {
        name "inlay hints show column types"
        input <<STYX
            AllProducts @query{
                from product
                select {
                    id
                    handle
                    active
                }
            }
            STYX
        inlay_hints {
            count 3
            has (
                {label ": BIGINT"}
                {label ": TEXT"}
                {label ": BOOLEAN"}
            )
        }
    }

    {
        name "hover on table shows columns"
        input <<STYX
            AllProducts @query{
                from prod|uct
            }
            STYX
        hover {
            contains ("Table `product`" "id" "handle" "status" "active")
        }
    }

    {
        name "hover on column shows type info"
        input <<STYX
            AllProducts @query{
                from product
                select {han|dle}
            }
            STYX
        hover {
            contains ("Column `product.handle`" "Type:" "TEXT")
        }
    }

    {
        name "diagnostic for unknown table"
        input <<STYX
            AllProducts @query{
                from nonexistent_table
            }
            STYX
        diagnostics {
            has ({message "Unknown table 'nonexistent_table'"})
        }
    }

    {
        name "diagnostic for unknown column"
        input <<STYX
            AllProducts @query{
                from product
                where {deleted_at @null}
                select {
                    id
                    nonexistent_column
                }
            }
            STYX
        diagnostics {
            count 1
            has ({message "Unknown column 'nonexistent_column'"})
        }
    }

    {
        name "no diagnostics for valid query"
        input <<STYX
            AllProducts @query{
                from product
                where {deleted_at @null}
                select {
                    id
                    handle
                }
            }
            STYX
        diagnostics {
            count 0
        }
    }

    {
        name "definition: param reference jumps to declaration"
        input <<STYX
            ProductByHandle @query{
                from product
                params {
                    handle TEXT
                }
                where {
                    deleted_at @null
                    handle @eq($han|dle)
                }
                select {id handle}
            }
            STYX
        definition {
            count 1
            has ({line 4})
        }
    }

    {
        name "definition: no result for non-param"
        input <<STYX
            AllProducts @query{
                from product
                where {deleted_at @null}
                select {han|dle}
            }
            STYX
        definition {
            empty true
        }
    }

    // ========================================================================
    // Query Linting Tests
    // ========================================================================

    {
        name "lint: offset without limit"
        input <<STYX
            BadQuery @query{
                from product
                where {deleted_at @null}
                offset 10
                select {id}
            }
            STYX
        diagnostics {
            count 1
            has ({message "without 'limit'" code "offset-without-limit"})
        }
    }

    {
        name "lint: limit without order-by"
        input <<STYX
            BadQuery @query{
                from product
                where {deleted_at @null}
                limit 10
                select {id}
            }
            STYX
        diagnostics {
            count 1
            has ({message "without 'order-by'" code "limit-without-order-by"})
        }
    }

    {
        name "lint: first without order-by"
        input <<STYX
            BadQuery @query{
                from product
                where {deleted_at @null}
                first true
                select {id}
            }
            STYX
        diagnostics {
            count 1
            has ({message "without 'order-by'" code "first-without-order-by"})
        }
    }

    {
        name "lint: no warning when limit has order-by"
        input <<STYX
            GoodQuery @query{
                from product
                where {deleted_at @null}
                order-by {id asc}
                limit 10
                select {id}
            }
            STYX
        diagnostics {
            count 0
        }
    }

    {
        name "lint: update without where"
        input <<STYX
            DangerousUpdate @update{
                table product
                set {status "deleted"}
            }
            STYX
        diagnostics {
            has ({message "without 'where'" code "mutation-without-where"})
        }
    }

    {
        name "lint: delete without where"
        input <<STYX
            DangerousDelete @delete{
                from product
            }
            STYX
        diagnostics {
            has ({message "without 'where'" code "mutation-without-where"})
        }
    }

    {
        name "lint: no warning when update has where"
        input <<STYX
            SafeUpdate @update{
                table product
                set {status "active"}
                where {id 1}
            }
            STYX
        diagnostics {
            count 0
        }
    }

    {
        name "lint: unused param"
        input <<STYX
            BadQuery @query{
                from product
                where {deleted_at @null}
                params {
                    unused_param TEXT
                }
                select {id}
            }
            STYX
        diagnostics {
            count 1
            has ({message "never used" code "unused-param"})
        }
    }

    {
        name "lint: no warning when param is used"
        input <<STYX
            GoodQuery @query{
                from product
                params {
                    handle TEXT
                }
                where {deleted_at @null, handle $handle}
                select {id}
            }
            STYX
        diagnostics {
            count 0
        }
    }

    {
        name "lint: missing deleted_at filter"
        input <<STYX
            BadQuery @query{
                from product
                select {id}
            }
            STYX
        diagnostics {
            count 1
            has ({message "doesn't filter 'deleted_at'" code "missing-deleted-at-filter"})
        }
    }

    {
        name "lint: no warning when deleted_at is filtered"
        input <<STYX
            GoodQuery @query{
                from product
                where {deleted_at @null}
                select {id}
            }
            STYX
        diagnostics {
            count 0
        }
    }

    {
        name "lint: hard delete on soft-delete table"
        input <<STYX
            BadDelete @delete{
                from product
                where {id 1}
            }
            STYX
        diagnostics {
            count 1
            has ({message "consider soft delete" code "hard-delete-on-soft-delete-table"})
        }
    }

    {
        name "lint: relation first without order-by"
        input <<STYX
            QueryWithRel @query{
                from product
                where {deleted_at @null}
                select {
                    id
                    translation @rel{
                        from product_translation
                        first true
                        select {title}
                    }
                }
            }
            STYX
        diagnostics {
            count 1
            has ({message "@rel without 'order-by'" code "rel-first-without-order-by"})
        }
    }

    {
        name "lint: no warning when relation has order-by"
        input <<STYX
            QueryWithRel @query{
                from product
                where {deleted_at @null}
                select {
                    id
                    translation @rel{
                        from product_translation
                        order-by {locale asc}
                        first true
                        select {title}
                    }
                }
            }
            STYX
        diagnostics {
            count 0
        }
    }

    // ========================================================================
    // Type Checking Tests
    // ========================================================================

    {
        name "lint: param type matches column type (string)"
        input <<STYX
            GoodQuery @query{
                from product
                params {handle @string}
                where {deleted_at @null, handle $handle}
                select {id}
            }
            STYX
        diagnostics {
            count 0
        }
    }

    {
        name "lint: param type matches column type (int)"
        input <<STYX
            GoodQuery @query{
                from product
                params {id @int}
                where {deleted_at @null, id $id}
                select {id}
            }
            STYX
        diagnostics {
            count 0
        }
    }

    {
        name "lint: param type mismatch - int param for text column"
        input <<STYX
            BadQuery @query{
                from product
                params {handle @int}
                where {deleted_at @null, handle $handle}
                select {id}
            }
            STYX
        diagnostics {
            count 1
            has ({message "type mismatch" code "param-type-mismatch"})
        }
    }

    {
        name "lint: param type mismatch - string param for bigint column"
        input <<STYX
            BadQuery @query{
                from product
                params {id @string}
                where {deleted_at @null, id $id}
                select {id}
            }
            STYX
        diagnostics {
            count 1
            has ({message "type mismatch" code "param-type-mismatch"})
        }
    }

    {
        name "lint: param type mismatch with operator"
        input <<STYX
            BadQuery @query{
                from product
                params {id @string}
                where {deleted_at @null, id @eq($id)}
                select {id}
            }
            STYX
        diagnostics {
            count 1
            has ({message "type mismatch" code "param-type-mismatch"})
        }
    }

    {
        name "lint: literal string matches text column"
        input <<STYX
            GoodQuery @query{
                from product
                where {deleted_at @null, handle "test"}
                select {id}
            }
            STYX
        diagnostics {
            count 0
        }
    }

    {
        name "lint: literal boolean matches boolean column"
        input <<STYX
            GoodQuery @query{
                from product
                where {deleted_at @null, active true}
                select {id}
            }
            STYX
        diagnostics {
            count 0
        }
    }

    {
        name "lint: literal integer matches bigint column"
        input <<STYX
            GoodQuery @query{
                from product
                where {deleted_at @null, id 123}
                select {id}
            }
            STYX
        diagnostics {
            count 0
        }
    }

    {
        name "lint: literal string for boolean column"
        input <<STYX
            BadQuery @query{
                from product
                where {deleted_at @null, active "yes"}
                select {id}
            }
            STYX
        diagnostics {
            count 1
            has ({message "type mismatch" code "literal-type-mismatch"})
        }
    }

    {
        name "lint: literal string for bigint column"
        input <<STYX
            BadQuery @query{
                from product
                where {deleted_at @null, id "123"}
                select {id}
            }
            STYX
        diagnostics {
            count 1
            has ({message "type mismatch" code "literal-type-mismatch"})
        }
    }

    {
        name "lint: literal boolean for text column"
        input <<STYX
            BadQuery @query{
                from product
                where {deleted_at @null, handle true}
                select {id}
            }
            STYX
        diagnostics {
            count 1
            has ({message "type mismatch" code "literal-type-mismatch"})
        }
    }

    // ========================================================================
    // FK Relationship Tests
    // ========================================================================

    {
        name "lint: valid FK relationship (product -> product_translation)"
        input <<STYX
            GoodQuery @query{
                from product
                where {deleted_at @null}
                select {
                    id
                    translation @rel{
                        from product_translation
                        select {title}
                    }
                }
            }
            STYX
        diagnostics {
            count 0
        }
    }

    {
        name "lint: valid FK relationship (product_variant -> variant_price)"
        input <<STYX
            GoodQuery @query{
                from product_variant
                where {deleted_at @null}
                select {
                    id
                    prices @rel{
                        from variant_price
                        select {amount, currency_code}
                    }
                }
            }
            STYX
        diagnostics {
            count 0
        }
    }

    {
        name "lint: no FK relationship error"
        input <<STYX
            BadQuery @query{
                from product
                where {deleted_at @null}
                select {
                    id
                    prices @rel{
                        from variant_price
                        select {amount}
                    }
                }
            }
            STYX
        diagnostics {
            count 1
            has ({message "no FK relationship" code "no-fk-relationship"})
        }
    }

    {
        name "lint: no FK relationship between unrelated tables"
        input <<STYX
            BadQuery @query{
                from product_source
                select {
                    id
                    translations @rel{
                        from product_translation
                        select {title}
                    }
                }
            }
            STYX
        diagnostics {
            count 1
            has ({message "no FK relationship" code "no-fk-relationship"})
        }
    }
)
